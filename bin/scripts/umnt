#!/bin/bash

set -o errexit

umnt() {
    if [[ "$(lsblk -ndo TYPE "$1")" == "crypt" ]]; then
        # if LUKS encrypted device by label
        (set -x; udisksctl unmount -b "$1" $2) || exit 1
        DEV=$(lsblk -pnslo NAME "$1" | tail -n2 | head -n1 )
        (set -x; udisksctl lock -b "$DEV") || exit 1

    elif [[ "$(lsblk -no TYPE "$1" | tail -n1)" == "crypt" ]]; then
        # if LUKS encrypted devie by device name
        DM=$(lsblk -prno NAME "$1" | tail -n1)
        (set -x; udisksctl unmount -b "$DM" $2) || exit 1
        (set -x; udisksctl lock -b "$1") || exit 1
    else
        (set -x; udisksctl unmount -b "$1" $2)
    fi
}

# save mount options in OPT
[[ $2 == "-f" ]] && OPT="-f"

if [[ -b "$1" ]]; then
    # if first argument is block device
    umnt "$1" "$OPT"
elif [[ -b /dev/"$1" ]]; then
    # if first argument is device under /dev/ (e.g. sdXY)
    umnt /dev/"$1" "$OPT"
elif [[ -b /dev/disk/by-label/"$1" ]]; then
    # if first argument is label
    umnt /dev/disk/by-label/"$1" "$OPT"
fi

